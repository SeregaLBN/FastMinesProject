apply plugin: 'java'
apply plugin: 'application'

/** /
// see https://plugins.gradle.org/plugin/com.palantir.graal
buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "gradle.plugin.com.palantir.graal:gradle-graal:0.3.0-37-g77aa98f"
    }
}
apply plugin: 'com.palantir.graal'

graal {
//    //mainClass 'com.palantir.test.Main'
//    //outputName 'hello-world'
//    //graalVersion '1.0.0-rc5'
    graalVersion '1.0.0-rc16'
    downloadBaseUrl 'https://github.com/oracle/graal/releases/download/'
//    //graalVersion '19.0.0'
//    //option '-H:EnableURLProtocols=http'
//    //option '-H:Name=foo'
}
/**/

sourceCompatibility = JavaVersion.VERSION_1_8
targetCompatibility = JavaVersion.VERSION_1_8

compileJava.options.encoding = 'UTF-8'

group = 'FastMinesGame' // fmg

jar {
    manifest {
        attributes 'Vendor': 'SeregaLBN',
                   'Build-Date': new Date().format("yyyy-MM-dd'T 'HH:mm:ss.SSSZZ")
    }
}

mainClassName = "fmg.swing.app.MainApp"

sourceSets {
    main {
        java {
            srcDir '../src/src_platform_swing'
            srcDir 'src/main/java'
            include '**/*.java'
        }
        resources {
          //srcDir 'src/test/resources'
//          srcDir '../res'
//          exclude '**/*~*'
//          include '**/*.gif'
//          include '**/*.jpeg'
//          include '**/*.jpg'
//        //include '**/*.ico'
//          include '**/*.png'
        }
    }
    test {
        java {
            srcDir 'src/test/java'
            srcDir '../src/test_swing'
            include '**/*.java'
        }
    }
}


dependencies {
    compile project(':FastMines_core')
    compile 'io.reactivex.rxjava2:rxjava:2.2.8'

    testImplementation project(':FastMines_core').sourceSets.test.output

    // Use JUnit test framework
    testImplementation 'junit:junit:4.12'
}

test.dependsOn(":FastMines_core:test")

//jar {
//    into('res') {
//        from '../res'
//        exclude '**/*~*'
//        include '**/*.png'
//    }
//}

version = '2.0.3'

jar {
    manifest {
        attributes 'Main-Class': mainClassName,
                   'Title'     : 'FastMines game - Java SWING desktop application',
                   'Version'   : version
    }
}


task fastMinesSwingFatJar(type: Jar) {
    manifest {
        attributes jar.manifest.attributes
    }
    baseName = 'FastMines_swing-fat'
    from {
        configurations.compile.collect {
            it.isDirectory()
                ? it
                : zipTree(it).matching{exclude{
                    //println it
                    //it.name == 'META-INF'
                    it.toString().contains('!META-INF')
                }}
        }
    }
    with jar
}
project(':FastMines_swing').tasks.fastMinesSwingFatJar.dependsOn project(':FastMines_core' ).tasks.build
project(':FastMines_swing').tasks.build               .dependsOn project(':FastMines_swing').tasks.fastMinesSwingFatJar

task fastMinesSwingGraalNative(dependsOn: fastMinesSwingFatJar) { task ->
    doLast {
        /** /
        def execResult = exec {
            workingDir System.env.GRAALVM_HOME + '/bin'
            executable 'native-image'
            args '-cp ' + project(':FastMines_swing').buildDir.absolutePath + '/libs/FastMines_swing-fat-' + version + '.jar'\
                , '-H:Class=' + mainClassName\
                , '-H:Name=FastMines_swing'\
                , '--no-fallback'\
                , '-H:+ReportExceptionStackTraces'\
                , '--allow-incomplete-classpath'
                
        }
        /**/
        exec {
            //commandLine 'sh', '-c', \
            commandLine 'cmd', '/c', \
                   System.env.GRAALVM_HOME + '/bin/native-image' \
                + ' -cp ' + project(':FastMines_swing').buildDir.absolutePath + '/libs/FastMines_swing-fat-' + version + '.jar'\
                + ' -H:Class=' + mainClassName \
                + ' -H:Name=FastMines_swing' \
                + ' --no-fallback' \
                + ' -H:+ReportExceptionStackTraces' \
                + ' --allow-incomplete-classpath'
        }
        /**/
    }
}
task fastMinesSwingJPackNative(dependsOn: fastMinesSwingFatJar) { task ->
    doLast {
        exec {
            commandLine 'javapackager',
                '-deploy -native exe',
                '-BsystemWide=true',
                '-BjvmOptions=-Xmx128m', 
                '-BjvmOptions=-Xms128m',
                '-outdir ' + project(':FastMines_swing').buildDir.toPath().resolve('distributions').toFile().absolutePath,
                '-outfile FastMines' + version,
                //'-srcdir ' + project(':FastMines_swing').srcDir.absolutePath,   // Base directory of the files to pack.
                '-srcdir ' + sourceSets.main.java.srcDirs,
              //'-srcfiles zzzzz.jar',                                   // List of files in srcdir. If omitted, all files in srcdir (which is a mandatory argument in this case) will be used.
                '-appclass ' + mainClassName,
                '-description "FastMines game - Java SWING desktop application"',
                '-name FastMines',
                '-title "FastMines"'
        }
    }
}
